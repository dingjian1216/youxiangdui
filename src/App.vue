<template>
  <div id="app">
    <div id="header" :style="{height: h,}"></div>
    <div class="viewBox" :style="{top: h}">
      <router-view v-if="isRouterAlive" />
    </div>
    <div v-transfer-dom>
      <confirm
        v-model="SnName"
        :show-cancel-button="false"
        placeholder="请输入终端名称"
        title="提示"
        show-input
        ref="confirm"
        @on-confirm="onConfirm"
      ></confirm>
    </div>
    <div v-transfer-dom>
      <x-dialog v-model="activity" id="showActivity" hide-on-blur>
        <div class="showAction">
          <img :src="active.cover" alt class="bg" @click="gourl()" />
          <img src="./assets/img/close.png" class="close" @click="activity = false" />
        </div>
      </x-dialog>
    </div>
  </div>
</template>
<script>
import * as utils from "./utils";
import { XDialog, Confirm, TransferDomDirective as TransferDom } from "vux";
export default {
  components: {
    XDialog,
    Confirm
  },
  directives: {
    TransferDom
  },
  name: "App",
  provide() {
    return {
      reload: this.reload
    };
  },
  data() {
    return {
      isRouterAlive: true,
      activity: false,
      active: "",
      h: "",
      anh: 25,
      SnName: false,
      iosh: 20,
      hideTitle: ["home", "my", "sign"],
      version: "",
      transitionName: ""
    };
  },
  watch: {
    $route(to, from) {
      if (this.hideTitle.indexOf(to.name) > -1 || !window.api) {
        this.h = 0;
      } else {
        if (api.systemType === "android") {
          this.h = this.anh;
        } else {
          this.h = this.iosh;
        }
      }
      var bdTTS = api.require("bdTTS");
      bdTTS.speakPause(function(ret) {});
      if (to.name == "home") {
        let text = "选择可兑,一切可兑";
        var bdTTS = api.require("bdTTS");
        bdTTS.speak(
          {
            text: text
          },
          function(ret) {}
        );
      }
      let systemVersion = (window.api && api.systemVersion) || "6.0";
      if (parseFloat(systemVersion) < 6.0) {
        this.colors = "#e65013";
      } else {
        this.colors = "#fff";
      }
    }
  },
  created() {
    let that = this;
    that.$store.commit("setSn", "VB09204E00609");
    // 进入前台
    let size = document.documentElement.clientWidth / 7.5;
    if (window.api) {
      if (api.systemType === "android") {
        this.h = api.safeArea.top / size + "rem";
        this.anh = this.h;
      } else {
        this.h = api.safeArea.top / size + "rem";
        this.iosh = this.h;
      }
    }
    if (this.hideTitle.indexOf(that.$route.name) > -1) {
      this.h = 0;
    }
    window.api &&
      api.setStatusBarStyle({
        style: "white",
        color: "#e65013"
      });
    let systemVersion = (window.api && api.systemVersion) || "6.0";
    if (parseFloat(systemVersion) < 6.0) {
      that.colors = "#e65013";
    } else {
      that.colors = "#fff";
    }
    let sn = this.$store.state.global.sn;
    let name = this.$store.state.global.userName;
    this.getAdvertisement();
    if (!sn || !name) {
      this.isSn();
      that.$store.commit("setSn", "VB09204E00609");
    }
  },
  methods: {
    reload() {
      this.isRouterAlive = false;
      this.$nextTick(() => {
        this.isRouterAlive = true;
      });
    },
    isSn() {
      let that = this;
      that.SnName = true;
      let Getsn = api.require("moduleDemo");
      Getsn.getSn({}, function(ret) {
        if (ret.sn) {
          that.$store.commit("setSn", ret.sn);
          that.sn = ret.sn;
          that.SnName = true;
        }
      });
    },
    getAdvertisement() {
      this.$http.post("news/getAdvertisement", {}).then(res => {
        if (res.code === 1 && res.data.cover) {
          this.activity = true;
          this.active = res.data;
        }
      });
    },
    gourl() {
      if (this.active.url) {
        var browser = api.require("webBrowser");
        this.activity = false;
        browser.open({
          url: this.active.url
        });
      } else {
        this.activity = false;
      }
    },
    onConfirm(value) {
      let that = this;
      this.$http
        .post("/stock/active", { sn: this.sn, name: value })
        .then(res => {
          if (res.code == 0) {
            that.$vux.toast.text("激活成功");
            that.$store.commit("setUserName", value);
          } else {
            that.$vux.toast.text(res.msg);
          }
        });
    }
  },
  mounted() {
    var bdTTS = api.require("bdTTS");
    bdTTS.init(
      {
        mode: "MIX"
      },
      function(ret) {}
    );
    var bdTTS = api.require("bdTTS");
    bdTTS.speakPause(function(ret) {});
    let text = "选择可兑,一切可兑";
    var bdTTS = api.require("bdTTS");
    bdTTS.speak(
      {
        text: text
      },
      function(ret) {}
    );
  }
};
</script>
<style lang="less">
#showActivity .weui-dialog {
  background-color: transparent;
  z-index: 5010;
}
.showAction {
  .close {
    margin-top: 0.2rem;
    width: 0.5rem;
  }
}
</style>
<style lang="less">
@import "~vux/src/styles/reset.less";
@import "~vux/src/styles/1px.less";
@import "./assets/less/app.less";
@import "./assets/less/font.css";
.weui-dialog__btn_primary {
  color: #e65013;
  z-index: 100;
}
.vux-prompt {
  margin-top: 0.2rem;
}
#app {
  height: 100%;
  position: relative;
  #header {
    position: relative;
    z-index: 1000000;
    overflow: hidden;
    width: 100%;
    /*height: 25px;*/
  }
  .viewBox {
    position: absolute;
    left: 0;
    top: 25px;
    width: 100%;
    bottom: 0;
  }
}

/*上拉加载无数据的时候图片的样式*/
.mescroll-empty {
  padding-top: 130px !important;
}
.mescroll-empty .empty-icon {
  width: 35% !important;
}

//  进入页面路由动画定义
@keyframes slideInLeft {
  from {
    transform: translate3d(100%, 0, 0);
    position: fixed;
    top: 0;
    left: 0;
    opacity: 1;
  }
  to {
    transform: translate3d(0, 0, 0);
    position: fixed;
    top: 0;
    left: 0;
    opacity: 1;
  }
}
@keyframes slideInRight {
  from {
    transform: translate3d(0%, 0, 0);
    position: fixed;
    top: 0;
    left: 0;
    opacity: 1;
  }
  to {
    transform: translate3d(-100%, 0, 0);
    position: fixed;
    top: 0;
    left: 0;
    opacity: 1;
  }
}
.slide-left-enter-active {
  position: fixed;
  top: 0;
  left: 0%;
  width: 100vw;
  height: 100vh;
  animation: slideInLeft 0.2s linear forwards;
}
.slide-left-leave-active {
  position: fixed;
  top: 0;
  left: 0%;
  width: 100vw;
  height: 100vh;
  animation: slideInRight 0.2s linear forwards;
}
@keyframes slideOutLeft {
  from {
    transform: translate3d(-100%, 0, 0);
    position: fixed;
    top: 0;
    left: 0;
    opacity: 1 !important;
  }
  to {
    transform: translate3d(0%, 0, 0);
    position: fixed;
    top: 0;
    left: 0;
    opacity: 1;
  }
}
@keyframes slideOutRight {
  from {
    transform: translate3d(0%, 0, 0);
    position: fixed;
    top: 0;
    left: 0;
    opacity: 1;
  }
  to {
    transform: translate3d(100%, 0, 0);
    position: fixed;
    top: 0;
    left: 0;
    opacity: 1;
  }
}
.slide-right-enter-active {
  position: fixed;
  top: 0;
  left: 0%;
  width: 100vw;
  height: 100vh;
  animation: slideOutLeft 0.2s linear forwards;
}
.slide-right-leave-active {
  position: fixed;
  top: 0;
  left: 0%;
  width: 100vw;
  height: 100vh;
  animation: slideOutRight 0.2s linear forwards;
}
</style>